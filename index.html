<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</title>

<style>
body{
  margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;
  font-family:system-ui;background:linear-gradient(135deg,#0f172a,#312e81);padding:16px
}
.app{background:#fff;width:100%;max-width:1100px;border-radius:24px;padding:24px}
h1{text-align:center}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
label{font-weight:600;font-size:14px}
input,textarea,button{width:100%;margin-top:6px;padding:12px;border-radius:12px}
textarea{min-height:180px}
button{background:#6366f1;color:#fff;font-weight:700;border:none;cursor:pointer}
button.secondary{background:#e5e7eb;color:#000;margin-top:60px}

.counter{
  display:none;
  text-align:center;
  font-size:96px;
  font-weight:900;
  color:#6366f1;
  margin-top:30px;
  animation: pop 0.6s ease;
}

@keyframes pop{
  0%{transform:scale(0.3);opacity:0}
  60%{transform:scale(1.2);opacity:1}
  100%{transform:scale(1);opacity:1}
}

.results{margin-top:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:#f8fafc;padding:16px;border-radius:16px;text-align:center}
.gift{font-weight:700;color:#6366f1}
.code{font-size:20px;font-weight:800}
</style>
</head>

<body>
<div class="app">
<h1>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</h1>

<div class="grid">
  <div>
    <label>CSV (promo_code;first_name;last_name;phone)</label>
    <input type="file" id="file" accept=".csv">

    <label style="margin-top:14px">–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
    <textarea id="gifts"></textarea>

    <button onclick="startDraw()">üé∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  </div>

  <div>
    <label>–°—Ç–∞—Ç—É—Å</label>
    <input id="status" disabled value="–û–∂–∏–¥–∞–Ω–∏–µ">

    <label style="margin-top:14px">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
    <input id="giftCount" disabled value="0">

    <button class="secondary" onclick="exportWinners()">üì§ –°–∫–∞—á–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</button>
  </div>
</div>

<div class="counter" id="counter">1</div>
<div class="results" id="results"></div>
</div>

<script>
/* ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï –ü–û –ó–ê–ü–£–°–ö–ê–ú 5-13 ===== */
const FIXED_BY_DRAW = {
  5:'WTPHNSK',
  6:'CBMGUPC',
  7:'H5E7B29',
  8:'0J282IW',
  9:'CAX4D9W',
  10:'L5DT156',
  11:'E18EVTP',
  12:'3ZN69V4',
  13:'DBNQ3EZ'
};

const STORAGE_KEY='draw_state_final_14';

let users=[], winners=[];
let state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{drawCount:0,fixed:{}};
const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(state));

file.addEventListener('change',e=>{
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(Boolean);
    users=lines.slice(1).map(l=>{
      const v=l.split(';');
      return{
        promo_code:v[0]?.trim(),
        first_name:v[1]?.trim(),
        last_name:v[2]?.trim(),
        phone:v[3]?.trim()||'‚Äî'
      };
    }).filter(u=>u.promo_code);
    status.value='CSV –∑–∞–≥—Ä—É–∂–µ–Ω';
  };
  r.readAsText(e.target.files[0],'windows-1251');
});

gifts.addEventListener('input',()=>{
  giftCount.value=gifts.value.split('\n').filter(Boolean).length;
});

function startDraw(){
  state.drawCount++; save();
  winners=[]; results.innerHTML='';
  status.value=`–ó–∞–ø—É—Å–∫ ‚Ññ${state.drawCount}`;
  let giftsList=gifts.value.split('\n').map(g=>g.trim()).filter(Boolean);
  const used=new Set();

  animateCounter(()=>{
    const promo=FIXED_BY_DRAW[state.drawCount];
    if(promo && !state.fixed[state.drawCount]){
      const muzIndex=giftsList.findIndex(g=>g.toLowerCase().startsWith('muz'));
      const user=users.find(u=>u.promo_code===promo);
      if(muzIndex!==-1 && user){
        winners.push({...user,gift:giftsList[muzIndex]});
        used.add(promo);
        giftsList.splice(muzIndex,1);
        state.fixed[state.drawCount]=true; save();
      }
    }

    giftsList.forEach(g=>{
      let u;
      do{u=users[Math.floor(Math.random()*users.length)]}
      while(used.has(u.promo_code));
      used.add(u.promo_code);
      winners.push({...u,gift:g});
    });

    showResults();
    status.value='–ì–æ—Ç–æ–≤–æ';
  });
}

function animateCounter(done){
  const c=document.getElementById('counter');
  c.style.display='block';
  let i=1;
  const step=()=>{
    c.textContent=i;
    c.style.animation='none';
    void c.offsetWidth;
    c.style.animation='pop 0.6s ease';
    if(i<3){i++; setTimeout(step,700)}
    else setTimeout(()=>{c.style.display='none'; done();},700);
  };
  step();
}

function showResults(){
  results.innerHTML=winners.map(w=>`
    <div class="card">
      <div class="gift">üéÅ ${w.gift}</div>
      <div class="code">${w.promo_code}</div>
      <div style="margin-top:8px;font-size:14px;color:#475569">
        üìû <b>${w.phone}</b>
      </div>
    </div>
  `).join('');
}

function exportWinners(){
  if(!winners.length)return;
  const csv=winners.map(w=>
    `${w.gift};${w.promo_code};${w.first_name} ${w.last_name};${w.phone}`
  ).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='winners.csv';
  a.click();
}
</script>
</body>
</html>
