<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</title>
  <style>
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:linear-gradient(135deg,#0f172a,#312e81);padding:16px}
    body.fullscreen .app{max-width:100%;min-height:100vh;border-radius:0}
    .app{background:#fff;width:100%;max-width:1100px;border-radius:24px;padding:24px;box-shadow:0 40px 80px rgba(0,0,0,.35)}
    h1{text-align:center;margin-top:0;color:#1e293b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-weight:600;font-size:14px;display:block;margin-bottom:6px;color:#475569}
    input,textarea,button{width:100%;box-sizing:border-box;font-size:15px}
    input,textarea{padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc}
    textarea{min-height:200px;resize:vertical;font-family:monospace}
    button{margin-top:16px;padding:14px;border-radius:14px;border:none;font-size:16px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(135deg,#6366f1,#8b5cf6);transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button.secondary{background:#e2e8f0;color:#1e293b;margin-top:85px}
    .spinner{text-align:center;font-size:56px;display:none;margin-top:20px;animation:pulse .6s infinite alternate}
    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.15)}}
    .results{margin-top:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card-win{background:#ffffff;border:2px solid #f1f5f9;border-radius:20px;padding:20px;text-align:center;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1)}
    .gift{font-size:14px;font-weight:700;color:#6366f1;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
    .fio{font-size:20px;font-weight:800;color:#0f172a;margin:10px 0}
    .info-row{font-size:14px;color:#475569;margin-top:6px;display:flex;justify-content:center;gap:5px}
    .info-row b{color:#1e293b}
  </style>
</head>
<body class="fullscreen">
<div class="app">
  <h1>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</h1>

  <div class="grid">
    <div>
      <label>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV (–ü—Ä–æ–º–æ–∫–æ–¥ –≤–æ 2-–π –∫–æ–ª–æ–Ω–∫–µ)</label>
      <input type="file" id="file" accept=".csv" />

      <label style="margin-top:14px">2. –°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <textarea id="gifts" placeholder="iPhone 15&#10;MacBook Air&#10;–Ø–Ω–¥–µ–∫—Å –°—Ç–∞–Ω—Ü–∏—è"></textarea>

      <button onclick="startDraw()">üé∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</button>
    </div>

    <div>
      <label>–°—Ç–∞—Ç—É—Å</label>
      <input id="status" disabled value="–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö" />

      <label style="margin-top:14px">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <input id="giftCount" disabled value="0" />

      <button class="secondary" onclick="exportWinners()">üì§ –°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</button>
    </div>
  </div>

  <div class="spinner" id="spinner">üé≤</div>
  <div class="results" id="results"></div>
</div>

<script>
  // üîí –ó–ê–†–ê–ù–ï–ï –í–´–ë–†–ê–ù–ù–´–ï –ü–û–ë–ï–î–ò–¢–ï–õ–ò (–ø–æ –ü—Ä–æ–º–æ–∫–æ–¥—É)
  const presetWinners = {
   
  };

  let users = [];
  let winners = [];

  const giftsInput = document.getElementById('gifts');
  const giftCountInput = document.getElementById('giftCount');
  const statusInput = document.getElementById('status');

  giftsInput.addEventListener('input', () => {
    giftCountInput.value = giftsInput.value.split('\n').filter(Boolean).length;
  });

  document.getElementById('file').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    users = [];
    statusInput.value = '–ó–∞–≥—Ä—É–∑–∫–∞...';

    const reader = new FileReader();
    reader.onload = () => {
      let text = reader.result;
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      const delimiter = lines[0].includes(';') ? ';' : ',';

      users = lines.slice(1).map(line => {
        const v = line.split(delimiter);
        return {
          promo_id: v[0]?.trim(),
          promo_code: v[1]?.trim(), // Promo Code (–≤—Ç–æ—Ä–∞—è –∫–æ–ª–æ–Ω–∫–∞)
          user_id: v[2]?.trim(),
          first_name: v[3]?.trim(),
          last_name: v[4]?.trim(),
          phone: v[5]?.trim() || '‚Äî'
        };
      }).filter(u => u.promo_code && u.first_name);

      statusInput.value = '–ì–æ—Ç–æ–≤ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É';
    };
    reader.readAsText(file, 'windows-1251');
  });

  function startDraw(){
    const allGifts = giftsInput.value.split('\n').map(g=>g.trim()).filter(Boolean);
    if (!users.length || !allGifts.length) { alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–æ–¥–∞—Ä–∫–∏!'); return; }

    statusInput.value = '–ò—â–µ–º —Å—á–∞—Å—Ç–ª–∏–≤—á–∏–∫–æ–≤...';
    document.getElementById('spinner').style.display = 'block';
    document.getElementById('results').innerHTML = '';
    winners = [];

    const usedCodes = new Set();
    const distributedGifts = [];

    // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
    Object.entries(presetWinners).forEach(([pCode, gName]) => {
      const lucky = users.find(u => u.promo_code === pCode);
      if (lucky && allGifts.includes(gName)) {
        winners.push({...lucky, gift: gName});
        usedCodes.add(lucky.promo_code);
        distributedGifts.push(gName);
      }
    });

    let remainingGifts = [...allGifts];
    distributedGifts.forEach(g => {
      const idx = remainingGifts.indexOf(g);
      if (idx !== -1) remainingGifts.splice(idx, 1);
    });

    setTimeout(() => {
      // 2. –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤
      remainingGifts.forEach(gift => {
        let candidate;
        let attempts = 0;
        do {
          candidate = users[Math.floor(Math.random() * users.length)];
          attempts++;
        } while (usedCodes.has(candidate.promo_code) && attempts < 3000);

        if (!usedCodes.has(candidate.promo_code)) {
          usedCodes.add(candidate.promo_code);
          winners.push({...candidate, gift});
        }
      });

      document.getElementById('spinner').style.display = 'none';
      showResults();
      statusInput.value = '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω';
    }, 1000);
  }

  function showResults(){
    document.getElementById('results').innerHTML = winners.map(w => `
      <div class="card-win">
        <div class="gift">üéÅ ${w.gift}</div>
        <div class="fio">${w.promo_code}</div>
        <div class="fio">${w.first_name} ${w.last_name}</div>
        <div class="info-row">üìû –¢–µ–ª: <b>${w.phone}</b></div>
      </div>
    `).join('');
  }

  function exportWinners(){
    if (!winners.length) return;
    const head = ['–ü–æ–¥–∞—Ä–æ–∫', 'Promo Code', '–§–ò–û', '–¢–µ–ª–µ—Ñ–æ–Ω'];
    const body = winners.map(w => [w.gift, w.promo_code, `${w.first_name} ${w.last_name}`, w.phone]);
    const csv = [head, ...body].map(r => r.join(';')).join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'winners.csv';
    a.click();
  }
</script>
</body>
</html>
