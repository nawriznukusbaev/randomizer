<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</title>

  <style>
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;font-family:system-ui;background:linear-gradient(135deg,#0f172a,#312e81);padding:16px}
    .app{background:#fff;width:100%;max-width:1100px;border-radius:24px;padding:24px}
    h1{text-align:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-weight:600;font-size:14px}
    input,textarea,button{width:100%;margin-top:6px;padding:12px;border-radius:12px}
    textarea{min-height:180px}
    button{background:#6366f1;color:#fff;font-weight:700;border:none;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#000;margin-top:60px}
    .spinner{font-size:56px;text-align:center;display:none;margin-top:20px}
    .results{margin-top:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:#f8fafc;padding:16px;border-radius:16px;text-align:center}
    .gift{font-weight:700;color:#6366f1}
    .code{font-size:20px;font-weight:800}
  </style>
</head>

<body>
<div class="app">
  <h1>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</h1>

  <div class="grid">
    <div>
      <label>CSV (promo_code;first_name;last_name;phone)</label>
      <input type="file" id="file" accept=".csv">

      <label style="margin-top:14px">–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <textarea id="gifts"></textarea>

      <button onclick="startDraw()">üé∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <div>
      <label>–°—Ç–∞—Ç—É—Å</label>
      <input id="status" disabled value="–û–∂–∏–¥–∞–Ω–∏–µ">

      <label style="margin-top:14px">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <input id="giftCount" disabled value="0">

      <button class="secondary" onclick="exportWinners()">üì§ –°–∫–∞—á–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</button>
    </div>
  </div>

  <div class="spinner" id="spinner">üé≤</div>
  <div class="results" id="results"></div>
</div>

<script>
/* ================= –ù–ê–°–¢–†–û–ô–ö–ò ================= */

const FIXED_TV_ORDER = [
  'E8QZ7OD', // 3
  'L5DT156', // 4
  '3Y78RYR', // 5
  'VH30MWY'  // 6
];

const STORAGE_KEY = 'draw_state_v2';

/* ================= –°–û–°–¢–û–Ø–ù–ò–ï ================= */

let users = [];
let winners = [];

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  drawCount: 0,
  usedFixedPromos: []
};

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ================= –ó–ê–ì–†–£–ó–ö–ê CSV ================= */

document.getElementById('file').addEventListener('change', e => {
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split(/\r?\n/).filter(Boolean);
    users = lines.slice(1).map(l => {
      const v = l.split(';');
      return {
        promo_code: v[0]?.trim(),
        first_name: v[1]?.trim(),
        last_name: v[2]?.trim(),
        phone: v[3]?.trim() || '‚Äî'
      };
    }).filter(u => u.promo_code);
    status.value = 'CSV –∑–∞–≥—Ä—É–∂–µ–Ω';
  };
  reader.readAsText(e.target.files[0], 'windows-1251');
});

/* ================= –°–ß–Å–¢ –ü–û–î–ê–†–ö–û–í ================= */

gifts.addEventListener('input', () => {
  giftCount.value = gifts.value.split('\n').filter(Boolean).length;
});

/* ================= –†–û–ó–´–ì–†–´–® ================= */

function startDraw() {
  state.drawCount++;
  saveState();

  winners = [];
  results.innerHTML = '';
  spinner.style.display = 'block';
  status.value = `–ó–∞–ø—É—Å–∫ ‚Ññ${state.drawCount}`;

  let giftsList = gifts.value.split('\n').map(g => g.trim()).filter(Boolean);
  const usedCodes = new Set();

  /* ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –ü–û–†–Ø–î–û–ö 3‚Äì6 ===== */

  const orderIndex = state.drawCount - 3;

  if (orderIndex >= 0 && orderIndex < FIXED_TV_ORDER.length) {
    const promo = FIXED_TV_ORDER[orderIndex];

    if (!state.usedFixedPromos.includes(promo)) {
      const tvIndex = giftsList.findIndex(g =>
        g.toLowerCase().startsWith('televizor')
      );

      const user = users.find(u => u.promo_code === promo);

      if (tvIndex !== -1 && user) {
        winners.push({ ...user, gift: giftsList[tvIndex] });
        usedCodes.add(promo);
        giftsList.splice(tvIndex, 1);
        state.usedFixedPromos.push(promo);
        saveState();
      }
    }
  }

  /* ===== –°–õ–£–ß–ê–ô–ù–´–ï ===== */

  setTimeout(() => {
    giftsList.forEach(gift => {
      let u;
      do {
        u = users[Math.floor(Math.random() * users.length)];
      } while (usedCodes.has(u.promo_code));

      usedCodes.add(u.promo_code);
      winners.push({ ...u, gift });
    });

    spinner.style.display = 'none';
    showResults();
    status.value = '–ì–æ—Ç–æ–≤–æ';
  }, 700);
}

/* ================= –í–´–í–û–î ================= */

function showResults() {
  results.innerHTML = winners.map(w => `
    <div class="card">
      <div class="gift">üéÅ ${w.gift}</div>
      <div class="code">${w.promo_code}</div>
    </div>
  `).join('');
}

/* ================= –≠–ö–°–ü–û–†–¢ ================= */

function exportWinners() {
  if (!winners.length) return;
  const csv = winners.map(w =>
    `${w.gift};${w.promo_code};${w.first_name} ${w.last_name};${w.phone}`
  ).join('\n');

  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'winners.csv';
  a.click();
}
</script>
</body>
</html>
