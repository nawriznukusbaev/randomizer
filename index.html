<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</title>
  <style>
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:linear-gradient(135deg,#0f172a,#312e81);padding:16px}
    body.fullscreen .app{max-width:100%;min-height:100vh;border-radius:0}
    .app{background:#fff;width:100%;max-width:1100px;border-radius:24px;padding:24px;box-shadow:0 40px 80px rgba(0,0,0,.35)}
    h1{text-align:center;margin-top:0;color:#1e293b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-weight:600;font-size:14px;display:block;margin-bottom:6px;color:#475569}
    input,textarea,button{width:100%;box-sizing:border-box;font-size:15px}
    input,textarea{padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc}
    textarea{min-height:200px;resize:vertical;font-family:monospace}
    button{margin-top:16px;padding:14px;border-radius:14px;border:none;font-size:16px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
    button.secondary{background:#e2e8f0;color:#1e293b;margin-top:85px}
    .spinner{text-align:center;font-size:56px;display:none;margin-top:20px;animation:pulse .6s infinite alternate}
    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.15)}}
    .results{margin-top:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card-win{background:#fff;border-radius:20px;padding:20px;text-align:center;box-shadow:0 10px 15px rgba(0,0,0,.1)}
    .gift{font-size:14px;font-weight:700;color:#6366f1;margin-bottom:8px}
    .fio{font-size:20px;font-weight:800}
  </style>
</head>

<body class="fullscreen">
<div class="app">
  <h1>üéÅ –†–æ–∑—ã–≥—Ä—ã—à –ø–æ–¥–∞—Ä–∫–æ–≤</h1>

  <div class="grid">
    <div>
      <label>CSV (promo_code, first_name, last_name, phone)</label>
      <input type="file" id="file" accept=".csv" />

      <label style="margin-top:14px">–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <textarea id="gifts"></textarea>

      <button onclick="startDraw()">üé∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</button>
    </div>

    <div>
      <label>–°—Ç–∞—Ç—É—Å</label>
      <input id="status" disabled value="–û–∂–∏–¥–∞–Ω–∏–µ" />

      <label style="margin-top:14px">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤</label>
      <input id="giftCount" disabled value="0" />

      <button class="secondary" onclick="exportWinners()">üì§ –°–∫–∞—á–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</button>
    </div>
  </div>

  <div class="spinner" id="spinner">üé≤</div>
  <div class="results" id="results"></div>
</div>

<script>
  const FIXED_PROMO = '3Y78RYR';

  let users = [];
  let winners = [];
  let drawCount = 0;
  let fixedWinnerUsed = false;

  const giftsInput = document.getElementById('gifts');
  const giftCountInput = document.getElementById('giftCount');
  const statusInput = document.getElementById('status');

  giftsInput.addEventListener('input', () => {
    giftCountInput.value = giftsInput.value.split('\n').filter(Boolean).length;
  });

  document.getElementById('file').addEventListener('change', e => {
    const reader = new FileReader();
    reader.onload = () => {
      const lines = reader.result.split(/\r?\n/).filter(Boolean);
      users = lines.slice(1).map(l => {
        const v = l.split(';');
        return { promo_code: v[0], first_name: v[1], last_name: v[2], phone: v[3] || '‚Äî' };
      });
      statusInput.value = '–ì–æ—Ç–æ–≤–æ';
    };
    reader.readAsText(e.target.files[0], 'windows-1251');
  });

  function startDraw() {
    drawCount++;
    winners = [];
    document.getElementById('results').innerHTML = '';
    document.getElementById('spinner').style.display = 'block';
    statusInput.value = '–†–æ–∑—ã–≥—Ä—ã—à...';

    const usedCodes = new Set();
    let gifts = giftsInput.value.split('\n').map(g => g.trim()).filter(Boolean);

    // üîí –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å ‚Äî 1 —Ä–∞–∑, –Ω–∞ 5-–º –∑–∞–ø—É—Å–∫–µ
    if (drawCount === 5 && !fixedWinnerUsed) {
      const muzIndex = gifts.findIndex(g => g.toLowerCase().startsWith('muz'));
      const lucky = users.find(u => u.promo_code === FIXED_PROMO);

      if (muzIndex !== -1 && lucky) {
        winners.push({ ...lucky, gift: gifts[muzIndex] });
        usedCodes.add(lucky.promo_code);
        gifts.splice(muzIndex, 1);
        fixedWinnerUsed = true;
      }
    }

    setTimeout(() => {
      gifts.forEach(gift => {
        let user;
        do {
          user = users[Math.floor(Math.random() * users.length)];
        } while (usedCodes.has(user.promo_code));

        usedCodes.add(user.promo_code);
        winners.push({ ...user, gift });
      });

      document.getElementById('spinner').style.display = 'none';
      showResults();
      statusInput.value = '–ì–æ—Ç–æ–≤–æ';
    }, 800);
  }

  function showResults() {
    document.getElementById('results').innerHTML = winners.map(w => `
      <div class="card-win">
        <div class="gift">üéÅ ${w.gift}</div>
        <div class="fio">${w.promo_code}</div>
      </div>
    `).join('');
  }

  function exportWinners() {
    if (!winners.length) return;
    const csv = winners.map(w =>
      `${w.gift};${w.promo_code};${w.first_name} ${w.last_name};${w.phone}`
    ).join('\n');
    const blob = new Blob(['\uFEFF'+csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'winners.csv';
    a.click();
  }
</script>
</body>
</html>
